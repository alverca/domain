# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/).

## Unreleased

### Added

### Changed

- POSと内部予約に対しても注文取引における承認価格バリデーションを追加
- 座席予約承認のイベント属性を最適化

### Deprecated

### Removed

- 注文取引から顧客連絡先属性を削除

### Fixed

### Security

## v27.0.0 - 2019-08-15

### Changed

- クレジットカード決済タスクをCinerino化
- クレジットカード以外の決済方法に対する承認アクションに対応

### Removed

- CreateOrderタスクを削除
- 注文取引から購入者区分属性を削除
- Salesサービスを削除

## v26.0.0 - 2019-08-13

### Changed

- 注文作成タスクをCinerino化
- 座席予約承認アクションインターフェースをCinerino化

### Removed

- 取引リポジトリから冗長なメソッドを削除

## v25.0.0 - 2019-08-09

### Changed

- タスクサービスをCinerino化
- アクション、注文、プロジェクト、販売者、タスク、取引リポジトリをCinerino継承
- 決済サービス、ユーティリティサービスをCinerino継承

### Removed

- 座席予約承認アクションリポジトリを削除

## v24.0.0 - 2019-08-06

### Changed

- クレジットカード決済承認アクションインターフェースをCinerino化
- 座席予約承認アクションインターフェースをCinerino化

## v23.3.1 - 2019-08-04

### Changed

- アクションコレクションに検索のためのインデックス追加

## v23.3.0 - 2019-08-01

### Changed

- アクション、タスク、取引、注文にプロジェクト属性を追加

## v23.2.0 - 2019-07-30

### Changed

- update @tokyotower/factory

## v23.1.0 - 2019-07-30

### Changed

- 座席予約承認アクションの仮予約データに、余分座席分が含まれないように調整
- 注文へのクレジットカード決済情報連携強化

## v23.0.0 - 2019-07-29

### Changed

- 中止タスクが存在しない場合に例外が投げられないように調整
- 車椅子予約を含む注文データに、余分座席分が含まれないように調整

### Removed

- mongooseのエクスポートを削除

## v22.0.1 - 2019-07-28

### Changed

- update @chevre/factory
- Chevre SDKをエクスポート

## v22.0.0 - 2019-07-26

### Changed

- 座席の在庫管理をChevreへ移行

### Removed

- 在庫リポジトリを削除

## v21.0.0 - 2019-07-24

### Changed

- GMOサイト設定をプロジェクトリポジトリから参照するように変更
- update @chevre/factory

## v20.0.0 - 2019-07-23

### Changed

- 券種IDと券種コードを分離
- 予約IDを購入番号と完全分離
- Chevreエンドポイント設定をプロジェクトリポジトリを参照するように変更

### Removed

- 座席予約オファーインターフェースから冗長な属性を削除

## v19.0.1 - 2019-07-19

### Changed

- install @tokyotower/factory

## v19.0.0 - 2019-07-17

### Added

- 予約検索条件の予約者に$elemMatchを追加

### Changed

- 予約データに購入番号を追加
- 予約番号と購入番号を分離
- update packages
- パッケージスコープをtokyotowerへ変更

### Removed

- 注文照会キーを削除

## v18.1.0 - 2019-07-15

### Changed

- 注文確認番号を上映日と予約番号の組み合わせに変更
- 注文コレクションのインデックス調整

## v18.0.0 - 2019-07-12

### Added

- オファーサービスを追加

### Changed

- イベントの座席情報をChevreから取得するように変更
- 複数座席の仮押さえを一度に実行するように変更
- 売上集計コレクションにインデックス追加

### Removed

- パフォーマンスインターフェースから券種情報を削除
- 仮予約インターフェースから冗長な属性を削除

## v17.1.1 - 2019-07-08

### Changed

- Chevreからの作品コードの引き継ぎを調整

## v17.1.0 - 2019-07-05

### Added

- パフォーマンス検索条件にIDを追加

## v17.0.0 - 2019-07-05

### Changed

- 予約の入場以外の全属性をChevre化
- 券種インターフェースをChevre化
- 予約変更時に更新日時を連携
- パフォーマンスを開始日時で検索時にstartDateを参照するように調整
- パフォーマンス検索条件をChevre化

### Removed

- 券種からキャンセルチャージ属性を削除
- 予約検索条件インターフェースから不要な属性を削除
- 注文取引結果からeventReservationsを削除(order.acceptedOffersへ移行)
- 仮予約インターフェースからrate_limit_unit_in_secondsを削除
- 仮予約インターフェースから座席グレードを削除
- パフォーマンスインターフェースから非推奨属性を削除
- レポートサービスを廃止
- 測定データリポジトリを削除

## v16.1.0 - 2019-06-23

### Changed

- 予約検索条件にイベント終了日時を追加

## v16.0.0 - 2019-06-22

### Removed

- 券種からキャンセルチャージ属性を削除

## v15.4.0 - 2019-06-19

### Changed

- パフォーマンスインターフェースを拡張

## v15.3.0 - 2019-06-19

### Changed

- 予約者識別子に値追加

## v15.2.0 - 2019-06-18

### Changed

- パフォーマンスインターフェースを拡張

## v15.1.1 - 2019-06-17

### Changed

- 予約検索条件強化

## v15.1.0 - 2019-06-17

### Changed

- 予約検索条件強化

## v15.0.2 - 2019-06-14

### Removed

- 売上集計サービスから不要なソースコードを削除
- 認証mongooseモデルを削除

## v15.0.1 - 2019-06-14

### Fixed

- 売上レポート対象から車椅子余分確保分予約を除外

## v15.0.0 - 2019-06-14

### Changed

- 予約検索条件を拡張
- 予約に追加特性を追加
- 車椅子の余分確保分を予約として作成するように調整
- 仮予約インターフェースを拡張

### Removed

- 在庫インターフェースを削除

## v14.1.2 - 2019-06-12

### Changed

- 券種のchargeをpriceSpecificationに置換

## v14.1.1 - 2019-06-11

### Changed

- 券種のchargeをpriceSpecificationに置換

## v14.1.0 - 2019-06-10

### Added

- 集計イベントリポジトリに削除メソッドを追加

## v14.0.0 - 2019-06-10

### Added

- 予約サービスを追加
- イベント予約集計タスクを追加
- 新しい集計つき一時イベントリポジトリを追加

### Changed

- パフォーマンス検索条件から作品関係を削除
- パフォーマンスコレクションからリレーションを削除
- 在庫リポジトリのmongooseモデルをprivate化
- 予約リポジトリのmongooseモデルをprivate化
- パフォーマンスリポジトリのmongooseモデルをprivate化
- 新しいRedis在庫リポジトリで再構築
- パフォーマンスインターフェースをChevre化に向けて補強
- スクリーンに車椅子タイプ座席をひとつ持つように設計調整

### Removed

- 劇場、スクリーン、作品、券種、券種グループコレクションを削除(一時的に動的データ管理を不可能に変更)
- GMO通知コレクションを削除
- SendGridイベントコレクションを削除
- パフォーマンスデータから不要な項目を削除
- jsdoc削除
- 一時イベントオファーリポジトリを削除
- パフォーマンス残席数リポジトリを削除
- オファーごとのパフォーマンス残席数リポジトリを削除

## v13.6.0 - 2019-05-26

### Added

- プロジェクトリポジトリを追加

## v13.5.0 - 2019-04-18

### Added

- 会員リポジトリを追加

### Changed

- 取引コレクションのインデックス調整
- 予約インターフェースをChevreを継承するように拡張
- 組織コレクションのインデックス調整
- 注文取引の購入者プロフィール情報の持ち方をCinerinoに統一
- install mongoose@5.5.1
- install @motionpicture/ttts-factory@1.0.1

### Removed

- 組織リポジトリを削除

## v13.4.0 - 2019-04-04

### Added

- 販売者リポジトリを追加

### Changed

- 返品レポート作成タスク追加のタイミングを、返品取引確定後から、返品処理完了後に変更

## v13.3.0 - 2018-12-22

### Added

- 注文検索を追加
- タスク検索を追加
- TriggerWebhookタスクを追加
- 取引検索を追加

## v13.2.4 - 2018-12-10

### Fixed

- moment-timezoneを適切にrequireできていないコードを修正

## v13.2.3 - 2018-12-10

### Changed

- 複数のWAITER許可証発行者に対応
- install @waiter/domain@3.0.0

## v13.2.2 - 2018-11-27

### Added

- 注文取引レポート作成タスクを追加。
- 注文返品取引レポート作成タスクを追加。
- 注文レポート更新タスクを追加。

### Changed

- 取引と予約の検索パフォーマンス向上のため、MongoDBのインデックスを調整。

## v13.2.1 - 2018-08-08
### Changed
- レポート集計をdelete/insertにする。

## v13.2.0 - 2018-06-23

### Changed

- 集計ドメインとリポジトリ追加（売上レポート集計用）

## v13.1.1 - 2018-04-17

### Changed

- 売上レポート出力時に使用するtransactionsのインデックスを調整。
- パフォーマンスの拡張属性に、販売ステータス最終更新時の予約データリストを追加。

## v13.1.0 - 2018-03-22

### Added

- 決済方法に手売りを追加。

### Changed

- MongoDBのreservationsとtransactionsに対して、レポートダウンロード時に使用するインデックスを追加。

### Fixed

- 販売者都合での返金完了メールの内容調整。

## v13.0.0 - 2018-03-14

### Changed

- イベントの販売情報ごとの在庫状況集計時に、集計日時fromとthroughを指定できるように変更。

## v12.1.4 - 2018-03-05
### Changed
- パフォーマンスの在庫状況集計時に集計日時fromとthroughを指定できるように変更。
- イベント販売情報更新ジョブにイベント開始日時fromとthroughを指定できるように変更。

### Fixed
- 流入制限あり券種の在庫数算出に対して、流入制限制限保持者がいない場合に残席数が考慮されていなかったので修正。
- パフォーマンスの集計データ作成時の、販売情報ごとの予約数カウントロジックを修正。
- 車椅子券種在庫数算出時に、同伴者分の在庫を考慮するように変更。

## v12.1.3 - 2018-02-14
### Changed
- 予約スキーマに注文取引主体属性を追加。

### Fixed
- パフォーマンス集計が毎秒の仕様であるのに対して、処理時間が数分、という状況に対して、処理自体をチューニング。
- 注文取引確定時の注文番号重複エラーをAlreadyInUseエラーとしてハンドリング。

## v12.1.2 - 2018-02-02
### Fixed
- 同じ上演日で購入番号が重複するバグを修正。
- クレジットカード決済のない注文の返品処理が完了しないバグを修正。

## v12.1.1 - 2018-02-01
### Fixed
- 購入者情報として日本以外の国の電話番号が登録できないバグを修正。

## v12.1.0 - 2018-01-18
### Added
- 健康診断サービスを追加。
- 取引ダウンロードサービスを追加。

## v12.0.0 - 2018-01-17
### Added
- 注文取引サービス、在庫状況サービス、在庫サービス、売上サービス、通知サービス、タスクサービスを追加。
- パフォーマンスに対する返品タスクを追加。
- パフォーマンスと在庫保管メソッドをレポジトリーに追加。
- 車椅子流入数制限の仕組みを追加。
- 券種カテゴリーレート制限リポジトリーを追加。
- パフォーマンスの券種ごとの在庫状況を更新するサービスを追加。
- トークンリポジトリーを追加。
- パフォーマンス検索サービスを追加。
- パフォーマンス集計データリポジトリーを追加。
- 入場ゲートリポジトリーを追加。
- 管理者サービスを追加。
- 注文作成タスクを追加。
- 販売情報リポジトリーを追加。
- 販売情報サービスを追加。

### Changed
- 取引と在庫スキーマを追加。予約を在庫を明確に分離。
- APIの認証情報をCognitoから取得するように変更。
- 注文返品取引スキーマを追加。
- パフォーマンスIDと在庫IDを文字列に変更。
- 購入番号を6桁に短縮。
- ownerのnameを一言語に限定。
- 購入番号リポジトリーをRedisへ移行。
- 取引にAPIクライアント情報を結合。
- 注文取引結果に印刷トークンを追加。
- 返品タスクに注文ステータス変更処理を追加。

### Removed
- MongoDBからclientsコレクションを削除。
- MongoDBからcustomer_cancel_requestsコレクションを削除。
- メールユーティリティを削除。
- GMO通知ユーティリティを削除。
- 所有者コレクションを削除(ユーザー情報をCognitoへ移行)

### Fixed
- パフォーマンス残席数が0にならないバグを解消。

## v11.2.0 - 2017-07-24
### Added
- mongooseをindexモジュールからエクスポート。
- クライアント作成サンプルを追加。

### Changed
- クライアントスキーマから不要なsecret_saltフィールドを削除。

### Security
- update package [tslint@5.5.0](https://www.npmjs.com/package/tslint)
- update package [typescript@2.4.2](https://www.npmjs.com/package/typescript)

## v10.0.0 - 2017-05-18
### Added
- 変更履歴を追加。
